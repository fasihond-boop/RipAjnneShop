<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - RipAjnne Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Kanit', sans-serif; background-color: #08080a; color: white; }
        .glass { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .input-style { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; width: 100%; outline: none; transition: 0.3s; color: white; }
        .input-style:focus { border-color: #dc2626; background: rgba(220, 38, 38, 0.05); }
        .btn-red { background: #dc2626; transition: 0.3s; cursor: pointer; }
        .btn-red:hover { background: #b91c1c; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(220, 38, 38, 0.3); }
        .tab-btn { padding: 10px 20px; border-radius: 12px; transition: 0.3s; cursor: pointer; color: #666; }
        .tab-btn.active { background: #dc2626; color: white; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <nav class="p-6 border-b border-white/5 mb-10 bg-[#08080a]/80 backdrop-blur-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-black italic text-red-600 uppercase tracking-tighter">Admin Control</h1>
            <div class="flex gap-4">
                <button onclick="switchSection('shop')" class="tab-btn active shop-tab-btn">จัดการสินค้า</button>
                <button onclick="switchSection('user')" class="tab-btn user-tab-btn">จัดการสมาชิก</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6">
        
        <div id="shopSection" class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <div class="lg:col-span-1 space-y-6">
                <div class="glass p-8 rounded-[30px] border-t-4 border-red-600 sticky top-32">
                    <h2 id="formTitle" class="text-xl font-bold mb-6 italic uppercase"><i class="fa-solid fa-cart-plus text-red-600 mr-2"></i>จัดการสินค้า</h2>
                    <input type="hidden" id="editId">
                    <div class="space-y-4">
                        <input type="text" id="p_name" class="input-style" placeholder="ชื่อสินค้า">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" id="p_price" class="input-style" placeholder="ราคา">
                            <select id="p_type" class="input-style">
                                <option value="normal">ปกติ</option>
                                <option value="gacha">สุ่ม (Gacha)</option>
                            </select>
                        </div>
                        <input type="text" id="p_img" class="input-style" placeholder="รูปภาพ URL">
                        
                        <div id="normalFields" class="space-y-4">
                            <input type="text" id="p_user" class="input-style" placeholder="ไอดี">
                            <input type="text" id="p_pass" class="input-style" placeholder="รหัสผ่าน">
                        </div>
                        <div id="gachaFields" class="hidden">
                            <textarea id="p_items" class="input-style h-24" placeholder="user1:pass1&#10;user2:pass2"></textarea>
                        </div>
                        
                        <button id="btnAdd" class="w-full btn-red py-4 rounded-2xl font-bold uppercase mt-4">บันทึกข้อมูล</button>
                        <button id="btnCancelEdit" class="hidden w-full bg-white/5 py-2 rounded-xl text-xs font-bold uppercase">ยกเลิกการแก้ไข</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="flex gap-4">
                    <button onclick="switchShopTab('normal')" id="tabN" class="text-sm font-bold border-b-2 border-red-600 pb-2">สินค้าปกติ</button>
                    <button onclick="switchShopTab('gacha')" id="tabG" class="text-sm font-bold text-gray-500 pb-2">กล่องสุ่ม</button>
                </div>
                <div class="glass rounded-[30px] overflow-hidden">
                    <table class="w-full text-left">
                        <tbody id="adminGrid"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="userSection" class="hidden max-w-4xl mx-auto">
            <div class="glass p-8 rounded-[40px] mb-10">
                <h2 class="text-2xl font-bold mb-6 italic uppercase text-red-600 text-center">Top-up System (เติมเงิน)</h2>
                <div class="flex gap-4">
                    <input type="email" id="targetEmail" class="input-style" placeholder="ใส่อีเมลลูกค้าที่ต้องการเติม">
                    <input type="number" id="topupAmount" class="input-style w-32" placeholder="จำนวนเงิน">
                    <button id="btnTopup" class="btn-red px-8 rounded-2xl font-bold uppercase whitespace-nowrap">เติมเงิน</button>
                </div>
                <p class="text-[10px] text-gray-500 mt-2 text-center">* ค้นหาจากอีเมลที่ลูกค้าสมัครไว้ในระบบ</p>
            </div>

            <div class="glass rounded-[30px] overflow-hidden">
                <div class="p-6 bg-white/5 border-b border-white/5 font-bold italic">รายชื่อสมาชิกทั้งหมด</div>
                <table class="w-full text-left">
                    <thead class="text-xs text-gray-500 uppercase bg-white/5">
                        <tr><th class="p-5">Email</th><th class="p-5">เงินคงเหลือ</th><th class="p-5 text-right">การจัดการ</th></tr>
                    </thead>
                    <tbody id="userGrid"></tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, updateDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAfML9ajHOufn3MDLSBZlXvaKl5YOobTpE",
            authDomain: "ripajnne-shop.firebaseapp.com",
            projectId: "ripajnne-shop",
            storageBucket: "ripajnne-shop.firebasestorage.app",
            messagingSenderId: "1046234530869",
            appId: "1:1046234530869:web:2af4b0bcc8f4a73a3e5d7c",
            measurementId: "G-QRF25429ZE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let shopTab = 'normal';
        let isEditing = false;

        // Section Switch
        window.switchSection = (sec) => {
            document.getElementById('shopSection').classList.toggle('hidden', sec !== 'shop');
            document.getElementById('userSection').classList.toggle('hidden', sec !== 'user');
            document.querySelector('.shop-tab-btn').classList.toggle('active', sec === 'shop');
            document.querySelector('.user-tab-btn').classList.toggle('active', sec === 'user');
        };

        // Shop Logic
        document.getElementById('p_type').onchange = (e) => {
            const isGacha = e.target.value === 'gacha';
            document.getElementById('normalFields').classList.toggle('hidden', isGacha);
            document.getElementById('gachaFields').classList.toggle('hidden', !isGacha);
        };

        window.switchShopTab = (tab) => {
            shopTab = tab;
            document.getElementById('tabN').classList.toggle('text-red-600', tab === 'normal');
            document.getElementById('tabN').classList.toggle('border-b-2', tab === 'normal');
            document.getElementById('tabG').classList.toggle('text-red-600', tab === 'gacha');
            document.getElementById('tabG').classList.toggle('border-b-2', tab === 'gacha');
            loadShop();
        };

        document.getElementById('btnAdd').onclick = async () => {
            const name = document.getElementById('p_name').value;
            const price = Number(document.getElementById('p_price').value);
            const img = document.getElementById('p_img').value;
            const type = document.getElementById('p_type').value;
            const id = document.getElementById('editId').value;

            const payload = { name, price, img };
            if(type === 'normal') {
                payload.id_user = document.getElementById('p_user').value;
                payload.id_pass = document.getElementById('p_pass').value;
            } else {
                const lines = document.getElementById('p_items').value.split('\n');
                payload.items = lines.filter(l => l.includes(':')).map(l => {
                    const [u, p] = l.split(':'); return { id_user: u, id_pass: p };
                });
            }

            try {
                if(isEditing) {
                    await updateDoc(doc(db, type === 'normal' ? "products" : "gacha", id), payload);
                    alert('อัปเดตเรียบร้อย');
                    cancelEdit();
                } else {
                    await addDoc(collection(db, type === 'normal' ? "products" : "gacha"), payload);
                    alert('เพิ่มสำเร็จ');
                }
                resetForm();
            } catch (e) { alert('ผิดพลาด!'); }
        };

        window.prepEdit = (id, data, type) => {
            isEditing = true;
            document.getElementById('editId').value = id;
            document.getElementById('p_name').value = data.name;
            document.getElementById('p_price').value = data.price;
            document.getElementById('p_img').value = data.img;
            document.getElementById('p_type').value = type;
            document.getElementById('p_type').dispatchEvent(new Event('change'));
            
            if(type === 'normal') {
                document.getElementById('p_user').value = data.id_user;
                document.getElementById('p_pass').value = data.id_pass;
            } else {
                document.getElementById('p_items').value = data.items.map(i => `${i.id_user}:${i.id_pass}`).join('\n');
            }
            document.getElementById('formTitle').innerText = "แก้ไขสินค้า";
            document.getElementById('btnCancelEdit').classList.remove('hidden');
        };

        function resetForm() {
            ['p_name', 'p_price', 'p_img', 'p_user', 'p_pass', 'p_items'].forEach(id => document.getElementById(id).value = '');
        }

        function cancelEdit() {
            isEditing = false;
            document.getElementById('formTitle').innerText = "จัดการสินค้า";
            document.getElementById('btnCancelEdit').classList.add('hidden');
            resetForm();
        }
        document.getElementById('btnCancelEdit').onclick = cancelEdit;

        window.delItem = async (id) => {
            if(confirm('ลบรายการนี้?')) await deleteDoc(doc(db, shopTab === 'normal' ? "products" : "gacha", id));
        };

        function loadShop() {
            const col = shopTab === 'normal' ? "products" : "gacha";
            onSnapshot(collection(db, col), (snap) => {
                document.getElementById('adminGrid').innerHTML = snap.docs.map(doc => {
                    const d = doc.data();
                    return `<tr class="border-b border-white/5">
                        <td class="p-5 font-bold">${d.name}</td>
                        <td class="p-5 text-red-500">฿${d.price}</td>
                        <td class="p-5 text-right flex justify-end gap-3 mt-4">
                            <button onclick='prepEdit("${doc.id}", ${JSON.stringify(d)}, "${shopTab}")' class="text-blue-500"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button onclick="delItem('${doc.id}')" class="text-red-600"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>`;
                }).join('');
            });
        }

        // User & Topup Logic
        document.getElementById('btnTopup').onclick = async () => {
            const email = document.getElementById('targetEmail').value;
            const amount = Number(document.getElementById('topupAmount').value);
            if(!email || !amount) return alert('กรุณาระบุข้อมูล');

            const q = query(collection(db, "users"), where("email", "==", email));
            const snap = await getDocs(q);
            if(snap.empty) return alert('ไม่พบอีเมลนี้ในระบบ');

            const userDoc = snap.docs[0];
            await updateDoc(doc(db, "users", userDoc.id), { balance: userDoc.data().balance + amount });
            alert('เติมเงินสำเร็จ!');
        };

        onSnapshot(collection(db, "users"), (snap) => {
            document.getElementById('userGrid').innerHTML = snap.docs.map(doc => {
                const u = doc.data();
                return `<tr class="border-b border-white/5">
                    <td class="p-5 text-xs text-gray-300">${u.email}</td>
                    <td class="p-5 font-bold text-red-500">฿${u.balance.toLocaleString()}</td>
                    <td class="p-5 text-right"><button onclick="document.getElementById('targetEmail').value='${u.email}'" class="text-[10px] bg-red-600 px-2 py-1 rounded">เลือกเติมเงิน</button></td>
                </tr>`;
            }).join('');
        });

        loadShop();
    </script>
</body>
    </html>
    
