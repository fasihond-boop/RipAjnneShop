<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RipAjnne - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Kanit', sans-serif; background: #0f172a; color: white; }
        .admin-card { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 20px; }
        input, textarea { background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; outline: none; width: 100%; margin-bottom: 10px; color: white; }
        textarea { min-height: 80px; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-red-500 italic uppercase">ADMIN CONTROL PANEL</h1>

        <div class="admin-card mb-8 shadow-xl">
            <h2 class="text-xl mb-4 text-blue-400 font-bold">üí∞ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Topup)</h2>
            <div class="flex gap-2">
                <input type="email" id="targetEmail" placeholder="‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
                <input type="number" id="amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" class="w-32">
            </div>
            <button onclick="updateBalance()" class="bg-blue-600 px-6 py-2 rounded-lg font-bold w-full hover:bg-blue-700 transition">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="admin-card">
                <h2 class="text-xl mb-4 text-green-400 font-bold">üì¶ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (Store)</h2>
                <input type="text" id="pName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                <input type="number" id="pPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤">
                <input type="text" id="pImg" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)">
                <input type="text" id="pUser" placeholder="Username">
                <input type="text" id="pPass" placeholder="Password">
                <button onclick="addProduct()" class="bg-green-600 px-6 py-2 rounded-lg font-bold w-full hover:bg-green-700 transition">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            </div>

            <div class="admin-card border-t-2 border-red-500">
                <h2 class="text-xl mb-4 text-red-400 font-bold">üé∞ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏π‡πâ‡∏™‡∏∏‡πà‡∏° (Add/Stock)</h2>
                <p class="text-[10px] text-gray-400 mb-2">*‡∏ñ‡πâ‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏π‡πâ‡∏ã‡πâ‡∏≥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏π‡πâ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                <input type="text" id="gName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏π‡πâ‡∏™‡∏∏‡πà‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏Å‡πà‡∏ï‡∏±‡∏ô)">
                <input type="number" id="gPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°">
                <input type="text" id="gImg" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡∏π‡πâ">
                <textarea id="gPool" placeholder="‡πÉ‡∏™‡πà‡πÑ‡∏≠‡∏î‡∏µ:‡∏û‡∏≤‡∏™ ‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô id1:pass1, id2:pass2"></textarea>
                <button onclick="addGacha()" class="bg-red-600 px-6 py-2 rounded-lg font-bold w-full hover:bg-red-700 transition uppercase">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏π‡πâ‡∏™‡∏∏‡πà‡∏°</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="admin-card">
                <h2 class="text-xl mb-4 text-gray-300">üìù ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</h2>
                <div id="adminProductList" class="space-y-2 text-sm"></div>
            </div>
            <div class="admin-card">
                <h2 class="text-xl mb-4 text-gray-300">üìù ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏π‡πâ‡∏™‡∏∏‡πà‡∏° (‡∏™‡∏ï‡πá‡∏≠‡∏Å)</h2>
                <div id="adminGachaList" class="space-y-2 text-sm"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, updateDoc, addDoc, collection, onSnapshot, query, where, getDocs, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAfML9ajHOufn3MDLSBZlXvaKl5YOobTpE",
            authDomain: "ripajnne-shop.firebaseapp.com",
            projectId: "ripajnne-shop",
            storageBucket: "ripajnne-shop.firebasestorage.app",
            messagingSenderId: "1046234530869",
            appId: "1:1046234530869:web:2af4b0bcc8f4a73a3e5d7c"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ---
        window.updateBalance = async () => {
            const email = document.getElementById('targetEmail').value;
            const cash = Number(document.getElementById('amount').value);
            const q = query(collection(db, "users"), where("email", "==", email));
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                await updateDoc(doc(db, "users", querySnapshot.docs[0].id), { balance: cash });
                alert("‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            } else { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!"); }
        };

        // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Store ---
        window.addProduct = async () => {
            await addDoc(collection(db, "products"), {
                name: document.getElementById('pName').value,
                price: Number(document.getElementById('pPrice').value),
                img: document.getElementById('pImg').value,
                id_user: document.getElementById('pUser').value,
                id_pass: document.getElementById('pPass').value
            });
            alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß!");
            location.reload();
        };

        // --- ‡∏£‡∏∞‡∏ö‡∏ö Gacha (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏á) ---
        window.addGacha = async () => {
            const name = document.getElementById('gName').value;
            const price = Number(document.getElementById('gPrice').value);
            const img = document.getElementById('gImg').value;
            const rawPool = document.getElementById('gPool').value;

            // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô Array ‡∏Ç‡∏≠‡∏á Object
            const newItems = rawPool.split(',').filter(item => item.includes(':')).map(item => {
                const [u, p] = item.trim().split(':');
                return { id_user: u, id_pass: p };
            });

            if(newItems.length === 0) return alert("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏≠‡∏î‡∏µ‡∏û‡∏≤‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ï‡∏π‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const q = query(collection(db, "gacha"), where("name", "==", name));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ï‡∏π‡πâ‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏´‡πâ "‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏á" ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏≠‡∏≤‡πÄ‡∏£‡∏¢‡πå‡πÄ‡∏î‡∏¥‡∏°
                const gachaDoc = querySnapshot.docs[0];
                const existingItems = gachaDoc.data().items || [];
                await updateDoc(doc(db, "gacha", gachaDoc.id), {
                    items: [...existingItems, ...newItems],
                    price: price, // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                    img: img // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                });
                alert(`‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏π‡πâ "${name}" ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å ${newItems.length} ‡∏ä‡∏¥‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß!`);
            } else {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏π‡πâ‡πÉ‡∏´‡∏°‡πà
                await addDoc(collection(db, "gacha"), {
                    name, price, img, items: newItems
                });
                alert("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏π‡πâ‡∏™‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            }
            location.reload();
        };

        // --- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ---
        onSnapshot(collection(db, "products"), (snap) => {
            document.getElementById('adminProductList').innerHTML = snap.docs.map(docSnap => `
                <div class="flex justify-between items-center bg-black/30 p-3 rounded-lg border border-white/5">
                    <span>${docSnap.data().name}</span>
                    <button onclick="deleteDocItem('products','${docSnap.id}')" class="text-red-500">‡∏•‡∏ö</button>
                </div>
            `).join('');
        });

        onSnapshot(collection(db, "gacha"), (snap) => {
            document.getElementById('adminGachaList').innerHTML = snap.docs.map(docSnap => {
                const data = docSnap.data();
                const stock = data.items ? data.items.length : 0;
                return `
                <div class="flex justify-between items-center bg-black/30 p-3 rounded-lg border border-white/5">
                    <div>
                        <p class="text-red-400 font-bold">${data.name}</p>
                        <p class="text-[10px] text-gray-400">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${stock} ‡∏ä‡∏¥‡πâ‡∏ô</p>
                    </div>
                    <button onclick="deleteDocItem('gacha','${docSnap.id}')" class="text-red-500">‡∏•‡∏ö‡∏ï‡∏π‡πâ</button>
                </div>
            `}).join('');
        });

        window.deleteDocItem = async (coll, id) => {
            if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏∞‡∏•‡∏ö?')) await deleteDoc(doc(db, coll, id));
        };
    </script>
</body>
</html>
